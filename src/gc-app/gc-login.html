<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../gc-styles/gc-shared-styles.html">
<link rel="import" href="../gc-common/gc-config.html">
<dom-module id="gc-login">
  <template>
    <style include="shared-styles"></style>
    <style>
    :host([authenticated]) {
      opacity: 0;
      pointer-events: none;
    }

    :host {
      @apply(--layout-fit);
      @apply(--layout-vertical);
      background-color: var(--default-primary-color);
      color: var(--dark-theme-text-color);
      --iron-icon-fill-color: var(--dark-theme-text-color);
      z-index: 999999999;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 2rem;
    }

    section {
      @apply(--layout-flex);
      @apply(--layout-vertical);
      @apply(--layout-center-center);
    }

    iron-image {
      margin-top: 1rem;
      margin-bottom: 2rem;
      height: 250px;
      width: 277px;
      --iron-image-height: 250px;
    }
    </style>
    <gc-config api-uri="{{apiUri}}"></gc-config>

    <app-route id="login" route="{{route}}" pattern="/login/success" query-params="{{_queryParams}}" active="{{_successRouteActive}}"></app-route>
    <app-route route="{{route}}" pattern="/login/error" query-params="{{_queryParams}}" active="{{_errorRouteActive}}"></app-route>
    <app-route route="{{route}}" pattern="/logout" active="{{_logoutRouteActive}}"></app-route>

    <section>
      <h1 hero-title>Gitcheese</h1>
      <iron-image sizing="contain" preload fade src="../../images/logo.svg" placeholder="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAADCAYAAABWKLW/AAAAAXNSR0IArs4c6QAAAAlwSFlzAAAK6wAACusBgosNWgAAAC9JREFUCB1jnNaX2Swpwmz1/M3fuSxKcuKmTGwiwtLMj40Z9u/fz3Hu3DkXBiAAAAj5DM/0IBh2AAAAAElFTkSuQmCC"></iron-image>
      <paper-button on-tap="_login">
        <iron-icon icon="account-circle"></iron-icon>Login With GitHub
      </paper-button>
      <template is="dom-if" if="[[_errorMessage]]">
        <h3>[[_errorMessage]]</h3>
      </template>
    </section>
  </template>
  <script>
  (() => {
    'use strict';
    class GcLogin {
      get is() {
        return 'gc-login';
      }
      get properties() {
        return {
          authenticated: {
            type: Boolean,
            reflectToAttribute: true
          },
          _queryParams: {
            type: Object
          },
          _errorMessage: {
            type: String
          }
        };
      }
      get observers() {
        return [
          '_handleLogin(_successRouteActive, _queryParams.token)',
          '_handleLoginError(_errorRouteActive, _queryParams.message)',
          '_handleLogout(_logoutRouteActive)'
        ];
      }
      _handleLogin(active, token) {
        if (!active) return;
        this.fire('logged-in', {token: token});
        window.history.pushState(null, 'root', '/app');
      }
      _handleLoginError(active, message) {
        if (!active) return;
        this._errorMessage = message;
      }
      _handleLogout(active) {
        if (!active) return;
        this.fire('logged-out');
      }
      _login() {
        window.location = `${this.apiUri}/tokens/github`;
      }
    }
    Polymer(GcLogin);
  })();
  </script>
</dom-module>
