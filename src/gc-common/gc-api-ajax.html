<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../gc-common/gc-auth.html">
<link rel="import" href="../gc-common/gc-config.html">

<dom-module id="gc-api-ajax">
  <template>
    <gc-config api-uri="{{apiUri}}"></gc-config>
    <gc-auth id="auth" token="{{token}}"></gc-auth>
    <iron-ajax id="ajax" url="[[apiUri]][[url]]" body="[[body]]" loading="{{loading}}" last-response="{{lastResponse}}" method="[[method]]" bubbles="true " content-type="application/json" handle-as="json"></iron-ajax>
  </template>
</dom-module>
<script>
(() => {
  class GcApijax {
    get is() {
      return 'gc-api-ajax';
    }
    get properties() {
      return {
        method: {
          type: String,
          value: 'GET'
        },
        loading: {
          type: Boolean,
          notify: true
        },
        lastResponse: {
          type: Object,
          notify: true
        },
        unauthorized: Boolean,
        _trigger: Boolean
      };
    }
    get observers() {
      return [
        '_generateRequestWhenReady(token, apiUri, trigger)',
        '_generateRequestWhenReady(unauthorized, apiUri, trigger)'
      ];
    }
    generateRequest() {
      this.trigger = !this.trigger;
    }
    _generateRequestWhenReady(token) {
      this.trigger = undefined;
      this.$.ajax.headers = Object.assign({
        'authorization': token
      }, this.headers);
      return this.$.ajax.generateRequest();
    }
    _generateUnauthorizedRequestWhenReady() {
      this.trigger = undefined;
      this.$.ajax.headers = this.headers;
      return this.$.ajax.generateRequest();
    }
  }
  Polymer(GcApijax);
})();
</script>
